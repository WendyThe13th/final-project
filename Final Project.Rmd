---
title: "Final Project"
author: "Mengqi Zhu & Shuang Wu & Yutian Mu & Dong Yuan"
date: "November 22nd 2017"
output: 
   html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```


```{r}
library(tidyverse)
library(readr)
library(janitor)
library(lubridate)
library(stringr)
library(chron)
library(forcats)
```


#Description
```{r}
#read and clean data
nyc_bus <- 
  read_csv("./Bus_Breakdown_and_Delays.csv") %>%
  clean_names() %>%
  filter(!is.na(boro)) %>%  #filter NA in boro variable
  mutate(bus_company_name = tolower(bus_company_name),
         company_name = str_sub(bus_company_name,1,5)) %>%   #find the unique company name
  select(school_year:bus_company_name,company_name,everything())
```

```{r}
#breakdwon vount over time
nyc_bus %>%
  separate(occurred_on, into = c("date", "time", "am_pm"), sep = " ") %>%
  mutate(datetime = format(strptime(str_c(time, am_pm, sep = " "), "%I:%M:%S %p"), "%H:%M:%S")) %>%
  count(datetime, boro) %>%
  rename(breakdown_count = n) %>%
  ggplot(aes(x = datetime, y = breakdown_count, fill = boro, color = boro)) +
  geom_point() +
  geom_smooth()
```

```{r}
#Number of Breakdown by boros
nyc_bus %>% 
  group_by(boro) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(boro = as.factor(boro),
         boro = fct_reorder(boro,n)) %>% 
  ggplot(aes(x = boro, y = n, fill = boro)) +
   geom_bar(stat = "identity",alpha = 0.8) +
   theme(axis.text.x = element_text(angle = 270)) +
   labs(y = "number of breakdown", title = "Number of Breakdown by boros")
```


```{r summary_function}
#Top routes where breakdowns or delays occur
summary_by_total <- function(data){
  list(variable = colnames(data),
       num_obs = rep(nrow(data), ncol(data)),
       mean = apply(data, 2, mean),
       sd = apply(data, 2, sd),
       min = apply(data, 2, min),
       median = apply(data, 2, median),
       max = apply(data, 2, max)) %>%
    as.tibble()
}
```

```{r summary_routes_breakdown}
nyc_bus %>%
  group_by(route_number) %>%
  summarize(n_route = n()) %>%
  select(n_route) %>%
  summary_by_total()
```
There are 11748 routes where breakdowns occur. We choose the most common ones with more than 200 breakdowns and make a barplot.

```{r top_routes_breakdown}
nyc_bus %>%
  group_by(route_number) %>%
  summarize(n_route = n()) %>%
  filter(n_route > 200) %>% 
  ungroup() %>%
  mutate(route_number = fct_reorder(route_number, n_route)) %>%
  ggplot(aes(x = route_number, y = n_route)) +
  geom_bar(stat = "identity", fill = "blue", alpha = .6) +
  coord_flip() +
  labs(title = "Top routes where breakdowns occur")
```



```{r reason_breakdown}
#Main reasons for school bus breakdowns and delays
reason_count = nyc_bus %>%
  group_by(reason) %>%
  filter(!is.na(reason))%>%
  summarize(n_reason = n()) %>%
  ungroup() %>%
  arrange(n_reason)
reason_count

reason_count %>%
  mutate(reason = fct_reorder(reason, n_reason)) %>%
  ggplot(aes(x = reason, y = n_reason)) +
  geom_bar(stat = "identity", fill = "blue", alpha = .6) +
  coord_flip() +
  labs(title = "Reasons for Breakdown")
```






