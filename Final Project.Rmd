---
title: "Final Project"
author: "Mengqi Zhu & Shuang Wu & Yutian Mu & Dong Yuan"
date: "November 22nd 2017"
output: 
   html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

<font size = 3>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE, 
                      message = FALSE, 
                      collapse = TRUE,
                      fig.width = 6,
                      fig.asp = .6,
                      out.width = "90%"
                      )


library(tidyverse)
library(readr)
library(janitor)
library(lubridate)
library(stringr)
library(chron)
library(forcats)
```

#1. Introduction
The Office of Pupil Transportation(OPT) administers school bus service to New York City schools for students attending both public and non-public schools, and it aims to use the Bus Breakdown and Delay system to inform parents who call with questions regarding bus service. The Bus Breakdown and Delay system collects information from school bus vendors operating out in the field in real time about the occur and inform time, delay duration, breakdown and delay reasons, and other operation information.

#2. Data and methods
Data consist of breakdown and delay information of schoolbus in New York during 2015-2016, 2016-2017 and 2017-2018 school years (except July, August and September), including occur time, inform time, delay duration, reason, bus company that provided service, run type, route and boro about breakdown and delay. These real time updated data are stored in Bus_Breakdown_and_Delays.csv. To prepare these data for analysis, we import, unity delay duration into minutes, and clear up company names by extracting common words.


```{r}
#Read and clean data
nyc_bus <- 
  read_csv("./Bus_Breakdown_and_Delays.csv") %>%
  clean_names() 

#Delay Clean
nyc_bus_delay <-
  nyc_bus %>%
  filter(grepl(pattern = '^[0-9]+', how_long_delayed, perl = TRUE) == TRUE) %>%
  select(busbreakdown_id,how_long_delayed) %>%
  mutate(how_long_delayed = tolower(how_long_delayed)) 

nyc_bus_delay_hour <-
  nyc_bus_delay %>%
  filter(grepl("h", how_long_delayed, ignore.case = T)== TRUE) %>%
  mutate(how_long_delayed 
         =
           ifelse(grepl("1 hr 30", how_long_delayed)== TRUE,"90",
                  ifelse(grepl("1 hr 45min", how_long_delayed)== TRUE,"105",
                         ifelse(grepl("1 hr 30min", how_long_delayed)== TRUE,"90",
                                ifelse(grepl("1hour", how_long_delayed)== TRUE,"60",
                                       ifelse(grepl("1 hour", how_long_delayed)== TRUE,"60",
                                              ifelse(grepl("1 h", how_long_delayed)== TRUE,"60",
                                                     ifelse(grepl("1h", how_long_delayed)== TRUE,"60",
                                                            ifelse(grepl("1/2", how_long_delayed)== TRUE,"30",
                                                                ifelse(grepl("2", how_long_delayed)== TRUE,"120",
                                                                       ifelse(grepl("4", how_long_delayed)== TRUE,"240","NA")))))))))))

nyc_bus_delay_min <- nyc_bus_delay %>%
  filter(grepl("h", how_long_delayed, ignore.case = T)== FALSE) %>%
  mutate(how_long_delayed = substr(how_long_delayed,1,2)) %>%
  mutate(how_long_delayed = sub(pattern = 'm',replacement = '', how_long_delayed),
         how_long_delayed = sub(pattern = '/',replacement = '', how_long_delayed),
         how_long_delayed = sub(pattern = ':',replacement = '', how_long_delayed),
         how_long_delayed = sub(pattern = 'o',replacement = '', how_long_delayed),
         how_long_delayed = sub(pattern = '-',replacement = '', how_long_delayed),
         how_long_delayed = sub(pattern = '02',replacement = '2', how_long_delayed),
         how_long_delayed = sub(pattern = '07',replacement = '7', how_long_delayed),
         how_long_delayed = sub(pattern = '00',replacement = '0', how_long_delayed),
         how_long_delayed = sub(pattern = '08',replacement = '8', how_long_delayed),
         how_long_delayed = sub(pattern = '01',replacement = '1', how_long_delayed),
         how_long_delayed = sub(pattern = '\\.',replacement = '', how_long_delayed)) %>%
  mutate(how_long_delayed = str_trim(how_long_delayed))

nyc_bus_delay <- rbind(nyc_bus_delay_hour,nyc_bus_delay_min)

nyc_bus <- nyc_bus %>% 
  select(- how_long_delayed) 
nyc_bus <- merge(nyc_bus,nyc_bus_delay, by.x = "busbreakdown_id", by.y = "busbreakdown_id", all = TRUE) %>%
  mutate(how_long_delayed = as.numeric(how_long_delayed))

#Company name clean
nyc_bus <-
  nyc_bus %>%
  filter(!is.na(boro)) %>%  #filter NAs
  mutate(bus_company_name = tolower(bus_company_name),
         company_name = str_sub(bus_company_name,1,5)) %>%   #find the unique company name
  select(school_year:bus_company_name,company_name,everything())
```

For this project, we focus on exploratory analyses and anticipation. Within the exploratory analysis, we compare different school bus companies by delay duration, reaction time and work fault.We also compare route services by the odds of notifying and the effect of route planning. Within the anticipation part, we build a model to predict the delay duration. Office of Pupil Transportation would be able to get the expected delay duration with this model and inform the parents who call.

#3. Results
##3.1 Description
### 3.1.1 Breakdown and Delay Distribution during the day 
```{r}
#Delay count over time by boros
nyc_bus %>%
  separate(occurred_on, into = c("date", "time", "am_pm"), sep = " ") %>%
  mutate(datetime = format(strptime(str_c(time, am_pm, sep = " "), "%I:%M:%S %p"), "%H:%M:%S")) %>%
  count(datetime, boro) %>%
  rename(delay_count = n) %>%
  ggplot(aes(x = datetime, y = delay_count, fill = boro, color = boro)) +
  geom_point() +
  geom_smooth() +
  ggtitle("Breakdown and Delay Distribution during the day") + 
  theme(text = element_text(size = 10),
        axis.text.x = element_text(angle = 90, hjust = 1),
        plot.title = element_text(hjust = 0.5)) +
  scale_x_discrete(breaks = c("00:00:00", "06:00:00", "12:00:00", "18:00:00"))
```

We found that during the day, the school bus delay occurs mainly focucs on 7:00-8:00am and 2:00-3:00pm, which are the commonsensible rush hours. The delay happens most frequently in Brooklyn and Bronx, and happens least frequently in Staten Island and Westchester, indicating the traffic condition of these boros.

###3.1.2 Reasons of breakdown and delay
```{r reason_breakdown}
# Main reasons for school bus breakdowns and delays
reason_count_break = nyc_bus %>%
  filter(breakdown_or_running_late == "Breakdown") %>%
  group_by(reason) %>%
  filter(!is.na(reason))%>%
  summarize(n_reason = n()) %>%
  ungroup() %>%
  arrange(n_reason)


reason_count_break <- reason_count_break %>%
  mutate(reason = fct_reorder(reason, n_reason)) %>%
  ggplot(aes(x = reason, y = n_reason)) +
  geom_bar(stat = "identity", fill = "blue", alpha = .6) +
  labs(title = "Reasons for Breakdown",y = "count") +
  theme(text = element_text(size = 10),
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 90, hjust = 1))

reason_count_delay = nyc_bus %>%
  filter(breakdown_or_running_late == "Running Late") %>%
  group_by(reason) %>%
  filter(!is.na(reason))%>%
  summarize(n_reason = n()) %>%
  ungroup() %>%
  arrange(n_reason)


reason_count_delay <- reason_count_delay %>%
  mutate(reason = fct_reorder(reason, n_reason)) %>%
  ggplot(aes(x = reason, y = n_reason)) +
  geom_bar(stat = "identity", fill = "blue", alpha = .6) +
  labs(title = "Reasons for Running Late",y = "count") +
  theme(text = element_text(size = 10),
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 90, hjust = 1))
gridExtra::grid.arrange(reason_count_break,reason_count_delay,ncol=2)
```

We found that the most commom known reasons for breakdown are mechanical problem, won't start and flat tire. We suggest the companies checking the condition of schoolbuses regularly. The most commom known reason for delay is heavy traffic.

###3.1.3 Average delay duration by reason
We want to find out what kind of problem tends to have longer delay duration.
```{r}
#Average delay duration by reason
nyc_bus %>%
  filter(!is.na(reason),
         !is.na(how_long_delayed)) %>%
  group_by(reason) %>%
  summarise(avg_time = mean(how_long_delayed)) %>%
  ggplot(mapping = aes(x = reason, y = avg_time, fill = reason)) + 
  geom_bar(stat= 'identity') +
  ggtitle("Average delay duration by reason") +
  labs(x = "Reason of delay", y = "Avergae delay duration") +
  theme(text = element_text(size = 10),
        axis.text.x = element_text(angle = 90, hjust = 1),
        plot.title = element_text(hjust = 0.5))
```

We can see the average delay duration by different reasons from the plot. Accident and mechanical problem tend to cause the longest delay duration while delayed by school and heavy traffic tend to have the shortest delay duration.

## 3.2 Exploratory Analysis
### 3.2.1 Comparison of different companies
#### 3.2.1.1 Distribution of delay duration of each company
```{r}
#distribution of delay duration for each company
company_level <- 
  nyc_bus %>%
  filter(!is.na(how_long_delayed)) %>%
  group_by(company_name) %>%
  summarise(mean_duration = mean(how_long_delayed, na.rm = T)) %>%
  arrange(desc(mean_duration)) %>%
  pull(company_name)


nyc_bus %>%
  mutate(company_name = forcats::fct_relevel(company_name, company_level)) %>%
  filter(!is.na(how_long_delayed)) %>%
  ggplot(aes(x = company_name, y = how_long_delayed)) + 
  geom_boxplot(aes(fill = company_name), color = "blue", alpha = .5, outlier.size = 0.7) + 
  stat_summary(fun.y = median, geom = "point", color = "blue") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none", 
        text = element_text(size = 10),
        plot.title = element_text(hjust = 0.5)) +
  labs(title = "Boxplot of delay duration for each company")
```

####3.2.1.2 Reaction time of notifying of each company
```{r}
#reaction time of notifying of each company
nyc_bus_reaction <- 
  nyc_bus %>%
  separate(occurred_on, into = c("occur_date", "occur_time", "occur_am_pm"), sep = " ") %>%
  separate(informed_on, into = c("inform_date", "inform_time", "inform_am_pm"), sep = " ") %>%
  mutate(occur_datetime = as.POSIXct(strptime(str_c(occur_time, occur_am_pm, sep = " "), "%I:%M:%S %p")),
         inform_datetime = as.POSIXct(strptime(str_c(inform_time, inform_am_pm, sep = " "), "%I:%M:%S %p")),
         reaction_time = inform_datetime - occur_datetime,
         is_same_time = as.Date(inform_date, format = "%m/%d/%Y") - as.Date(occur_date, format = "%m/%d/%Y"),
         occur_time = str_c(occur_date, occur_time, occur_am_pm, sep = " "),
         inform_time = str_c(inform_date, inform_time, inform_am_pm, sep = " "))

#the mean reaction time among the company occurred date and informed date are the same
nyc_bus_reaction %>%
  select(company_name, occur_time, inform_time, reaction_time, is_same_time) %>%
  filter(is_same_time == 0) %>%
  group_by(company_name) %>%
  summarise(mean_reaction = mean(reaction_time)) %>%
  arrange(desc(mean_reaction))
```

Reaction time is the time period between inform time and occur time. We find that "FORTUNA BUS COMPANY" has the longest reaction time of three and a half hours, following are "R & C TRANSIT, INC.", "SMART PICK" and "PENNY TRANSPORTATION"(2 hours and 1 hour, respectively).

#### 3.2.1.3 Work fault
```{r}
#inspect the cases that the occurred date and informed date are not the same
nyc_bus_reaction %>%
  select(occur_time, inform_time, reaction_time, is_same_time) %>%
  filter(is_same_time != 0) %>%
  arrange(is_same_time)
```

### 3.2.2 Comparison of route services
#### 3.2.2.1 Odds of notifying differed by route services
```{r}
  nyc_bus %>% 
  group_by(school_age_or_prek,has_contractor_notified_schools,has_contractor_notified_parents) %>%
  count() %>% 
  ungroup() %>% 
  mutate(notify = ifelse(has_contractor_notified_parents == "Yes" & has_contractor_notified_schools == "Yes","both","not_both")) %>% 
  select(school_age_or_prek,notify,n) %>% 
  group_by(school_age_or_prek,notify) %>% 
  summarise(count = sum(n)) %>% 
  spread(notify,count) %>% 
  mutate(odds = both/not_both) 
```

####3.2.2.2 Effect of route planning

It is a funny thing that while heavy traffic is NO.1 reason for delay, its average delay duartion is quite short. Then we are interested in which reason has the longest cumulative delay reason.
```{r}
nyc_bus %>%
  filter(!is.na(reason),
         !is.na(how_long_delayed)) %>%
  group_by(reason) %>%
  summarise(avg_time = mean(how_long_delayed), n_reason = n()) %>%
  mutate(cumulative = avg_time * n_reason) %>%
  arrange(cumulative) %>%
  select(-avg_time, -n_reason) %>%
  knitr::kable()
```

Then we can see from the table that heavy traffic has the longest cumulative delay duration. 

There are two types of  route service, one is for school-age and the other is for Pre-K/EI population. These two busing types have very different contract terms. OPT does not perform route planning for Pre-K service and doesn't assign route numbers. We want to find out whether different service type (having route planned by OPT or not) is associated with the time of delay.

```{r}
#Effect of route planning 
nyc_bus %>%
  filter(breakdown_or_running_late == "Running Late") %>%
  ggplot(aes(x = school_age_or_prek, y = how_long_delayed)) +
  geom_boxplot() +
  ggtitle("Effect of route planning") +
  labs(x = "Route servive", y = "Delay duration because of running late") +
  theme(text = element_text(size = 10),
        axis.text.x = element_text(angle = 90, hjust = 1),
        plot.title = element_text(hjust = 0.5))
```

We can see from the plot above that the route service for School-Age population has longer average delay duration because of running late than Pre-K. Besides, the distribution of delay duration of the route service for School-Age population has much more outliers. This means route planning has a negative effect on the school bus arriving in time. Given that heavy traffic is the NO.1 reason for delay and has the longest cumulative delay duration(has been disscussed above), we spectulate that this result is due to the inflexibility of route planning. School buses serving for School-Age can not change routes when running into heavy traffic, so they tend to delay longer than those for Pre-K. 

## 3.3 Anticipation

```{r}
#make classification of delay time according to quantiles
cutoff <- quantile(nyc_bus$how_long_delayed, c(0.33,0.67), na.rm = TRUE)
#initailly select covariates for logistics model
nyc_bus_logit <- 
  nyc_bus %>% 
  filter(!is.na(how_long_delayed)) %>% 
  mutate(delay_class = ifelse(how_long_delayed < cutoff[[1]], "short", ifelse(how_long_delayed > cutoff[[2]],"long","medium"))) %>%
  select(-c(bus_no, route_number, schools_serviced, created_on, bus_company_name, busbreakdown_id, 
            has_contractor_notified_schools, has_contractor_notified_parents, have_you_alerted_opt, 
            informed_on, incident_number, last_updated_on, how_long_delayed, run_type)) %>%
  separate(occurred_on, into = c("occur_date", "occur_time", "occur_am_pm"), sep = " ") %>%
  mutate(occur_hour = hour(as.POSIXct(strptime(str_c(occur_time, occur_am_pm, sep = " "), "%I:%M:%S %p")))) %>%
  select(-c(occur_date, occur_time, occur_am_pm)) %>%
  na.omit()
```

```{r}
#create training and testing sample from original dataset as 7:3 that is proportional to delay class
delay_short <- nyc_bus_logit %>% 
  filter(delay_class == "short")

delay_medium <- nyc_bus_logit %>% 
  filter(delay_class == "medium")

delay_long = nyc_bus_logit %>% 
  filter(delay_class == "long")

#produce random sample
set.seed(2017)
train_short_row <- sample(1:nrow(delay_short), 0.7*nrow(delay_short)) 
train_medium_row <- sample(1:nrow(delay_medium), 0.7*nrow(delay_medium)) 
train_long_row <- sample(1:nrow(delay_long), 0.7*nrow(delay_long)) 



training <-
  rbind(delay_short[train_short_row,],
        delay_medium[train_medium_row,],
        delay_long[train_long_row,]) %>%
  na.omit()

test <-
  rbind(delay_short[-train_short_row,],
        delay_medium[-train_medium_row,],
        delay_long[-train_long_row,]) %>%
  filter(!is.na(reason))
```

```{r}
library(nnet)
logit_reg <- multinom(delay_class ~ ., data = training)
#step(logit_reg)
#summary(logit_reg)
test_pre <- 
  as.tibble(predict(logit_reg, newdata = test, "probs")) %>%
  mutate(predict_class = apply(., 1, which.is.max),
         predict_class = recode(predict_class, "1" = "long", "2" = "medium", "3" = "short"))
#accuracy
bind_cols(test, test_pre) %>%
  mutate(accuracy = if_else(predict_class == delay_class, 1, 0)) %>%
  pull(accuracy) %>%
  sum()/nrow(test)
```

# 4. Discussion



